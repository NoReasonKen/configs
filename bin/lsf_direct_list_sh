#!/u/chehuang/bin/bash
help="Usage: lsf_direct_list_sh <MODULE>
- edag_perf has many hosts
- edag_shared has tons of hosts
"

source "/u/chehuang/bin/utils_src"
PATH=/u/chehuang/bin:$PATH

modules=(edag_int edag_perf edag_shared)

module=$1
[[ -z $module ]] && { echo "$help"; exit 0; }
if [[ ! " ${modules[*]} " =~ [[:space:]]${module}[[:space:]] ]]; then
    # shellcheck disable=SC2001
    utils::ERROR "Invalid module, please choose from {$(sed 's/\s/, /g' <<< "${modules[*]}")}\n" >&2
    exit 1
fi

# shellcheck disable=SC1090
source "/global/lsf/cells/$module/conf/profile.lsf"

# Example:
# 1                                                 2       3     4    5     6   7    8   9   10    11   12   13    14            15          16    17     18   19   20            21      22       23       24   25            26            27                           28        29    30         31        32  33  34              35      36   37         38      39    40
# HOST_NAME                                         status  r15s  r1m  r15m  ut  pg   io  ls  it    tmp  swp  mem   scratch_inst  cpu_factor  cpwr  mc     mpc  mtc  scratch_free  health  project  cputype  qsc  os_version    os            kernel_version               mem_inst  ncps  cpu_cache  cpu_code  vm  ht  scratch_policy  pool    brm  brm_group  res_id  bu    spot
# edagint-5021-005.static.us01-p08.synopsys.com     ok      0.0   0.0  0.0   0%  0.0  47  3   1     17G  52G  253G  704.5         -           -     100.0  -    1.0  668.6         1.0     NONE     amd64    w    AlmaLinux8.0  AlmaLinux8.4  4.18.0-425.3.1.el8.x86_64    256G      32    512K       epyc9754  1   0   2day_advanced   normal  1    edag       0       edag  local
# us01odcint-4648-041.static.us01-p08.synopsys.com  ok      0.0   0.0  0.0   0%  0.0  5   1   4590  17G  51G  251G  704.5         -           -     100.0  -    1.0  637.6         1.0     NONE     amd64    w    AlmaLinux8.0  AlmaLinux8.4  4.18.0-425.3.1.el8.x86_64    256G      32    512K       epyc9754  1   0   2day_advanced   normal  1    edag       0       edag  local
# us01odcint-4649-004.static.us01-p08.synopsys.com  ok      0.0   0.0  0.1   0%  0.0  3   0   2614  12G  52G  232G  704.5         -           -     100.0  -    1.0  668.6         1.0     NONE     amd64    s    CS7.0         CS7.3         3.10.0-1160.76.1.el7.x86_64  256G      32    512K       epyc9754  1   0   2day_advanced   normal  1    edag       0       edag  local
# us01odcint-4649-016.static.us01-p08.synopsys.com  ok      0.0   0.0  0.1   0%  0.0  5   2   166   12G  53G  210G  704.5         -           -     100.0  -    1.0  668.6         1.0     NONE     amd64    s    CS7.0         CS7.3         3.10.0-1160.76.1.el7.x86_64  256G      32    512K       epyc9754  1   0   2day_advanced   normal  1    edag       0       edag  local

# $2=status; $23=cputype; $24=qsc; $25=os_version; $36=brm; $37=brm_group
# $1=HOST_NAME; $28=mem_inst; $30=cpu_cache
data="$(lsload -l | awk '
    {
        if ( \
            $2 == "ok" &&
            $23 == "emt64" &&
            $24 == "w" &&
            $25 == "AlmaLinux8.0" &&
            ($36 == 0 || $37 == "NONE") \
        ) 
            print(NR, $1, $28, $30)
    }')"
header="# HOST_NAME mem_inst cpu_cache"
#data="$(sort -k 3 -h -r <<< "$data")"
column -t -s ' ' <<< "$header"$'\n'"$data" | less -N

